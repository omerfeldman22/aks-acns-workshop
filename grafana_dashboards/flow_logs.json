{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "Container network flow logs dashboard for monitoring network traffic, connections, and policies in Kubernetes clusters. Requires Advanced Container Networking Services (ACNS) to be enabled for flow log collection.",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 42,
  "links": [
    {
      "asDropdown": true,
      "icon": "external link",
      "includeVars": true,
      "keepTime": true,
      "tags": [
        "k8s:network-observability"
      ],
      "targetBlank": false,
      "title": "Dashboards: Network Observability",
      "tooltip": "",
      "type": "dashboards",
      "url": ""
    },
    {
      "asDropdown": false,
      "icon": "info",
      "includeVars": false,
      "keepTime": false,
      "tags": [],
      "targetBlank": true,
      "title": "Documentation",
      "tooltip": "",
      "type": "link",
      "url": "https://aka.ms/acns"
    }
  ],
  "panels": [
    {
      "description": "",
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 151,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "***NOTE: requires Advanced Container Networking Services to be enabled. See instructions to collect network flow logs at [aka.ms/acns](https://aka.ms/acns).***<br><br>**⚠️ ADVISORY:** If no data is visible in this dashboard, you may need to:<br><br>1. Apply the new Custom Resource Definition (CRD) to your cluster<br>2. Import the updated dashboards to ensure compatibility<br><br>Please check the documentation for the latest setup requirements [ContainerNetworkLogs](https://learn.microsoft.com/en-us/azure/aks/how-to-configure-container-network-logs?tabs=cilium#register-the-advancednetworkingflowlogs).",
        "mode": "markdown"
      },
      "pluginVersion": "11.6.3",
      "title": "",
      "type": "text"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 6
      },
      "id": 343,
      "panels": [],
      "title": "Connection Graph",
      "type": "row"
    },
    {
      "datasource": {
        "type": "grafana-azure-monitor-datasource",
        "uid": "${am_ds}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": true,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "super-light-blue"
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 5,
        "x": 0,
        "y": 7
      },
      "id": 388,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "11.6.3",
      "targets": [
        {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// Schema harmonization for both table types\r\nlet UnifiedFlowLogs =\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n);\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\nUnifiedFlowLogs\r\n| project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// verdict filter\r\n| extend verdictFilter = trim(\"'\", tostring(\"${verdict}\"))\r\n| where verdictFilter == \"ALL\" or Verdict == verdictFilter\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        Reply != 'true' and\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n    or\r\n    (\r\n        Reply and\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        Reply != 'true' and\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n    or\r\n    (\r\n        Reply and\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// transformations for visualization\r\n| summarize total_flows=count() by bin(TimeGenerated, rateInterval)\r\n",
            "resources": [
              "$resourceURI"
            ],
            "resultFormat": "time_series",
            "timeColumn": "TimeGenerated"
          },
          "azureMonitor": {
            "allowedTimeGrainsMs": [],
            "timeGrain": "auto"
          },
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "hide": false,
          "queryType": "Azure Log Analytics",
          "refId": "edges"
        }
      ],
      "title": "Total Flow Logs (requests and responses)",
      "transformations": [
        {
          "id": "renameByRegex",
          "options": {
            "regex": "total_flows",
            "renamePattern": "Total Flows"
          }
        },
        {
          "id": "renameByRegex",
          "options": {
            "regex": "unique_flows",
            "renamePattern": "Unique Requests"
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-azure-monitor-datasource",
        "uid": "${am_ds}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 24,
        "w": 14,
        "x": 5,
        "y": 7
      },
      "id": 160,
      "options": {
        "edges": {},
        "nodes": {
          "arcs": [],
          "mainStatUnit": "pps",
          "secondaryStatUnit": "percent"
        },
        "zoomMode": "cooperative"
      },
      "pluginVersion": "11.6.3",
      "targets": [
        {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "let seconds = toint(max_of(1, toreal(datetime_diff('second', $__timeTo(), $__timeFrom()))));\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project Verdict, Reply, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project Verdict, Reply, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| extend verdictFilter = trim(\"'\", tostring(\"${verdict}\"))\r\n| where verdictFilter == \"ALL\" or Verdict == verdictFilter\r\n// requests only, or drops, or L7 errors (will need to flip src/dst)\r\n| extend dns_response_error = Layer7.type == 'RESPONSE' and toint(Layer7.dns.rcode) > 0\r\n| extend http_response_error = Layer7.type == 'RESPONSE' and toint(Layer7.http.code) >= 300\r\n| extend l7_response_error = dns_response_error or http_response_error\r\n| where Reply != 'true' or Verdict == 'DROPPED' or l7_response_error\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend tmp = SourceNamespace\r\n| extend SourceNamespace = iff(l7_response_error, DestinationNamespace, SourceNamespace)\r\n| extend DestinationNamespace = iff(l7_response_error, tmp, DestinationNamespace)\r\n| extend tmp = SourcePodName\r\n| extend SourcePodName = iff(l7_response_error, DestinationPodName, SourcePodName)\r\n| extend DestinationPodName = iff(l7_response_error, tmp, DestinationPodName)\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| extend tmp = SourceIdentity\r\n| extend SourceIdentity = iff(l7_response_error, DestinationIdentity, SourceIdentity)\r\n| extend DestinationIdentity = iff(l7_response_error, tmp, DestinationIdentity)\r\n| extend is_drop = Verdict == 'DROPPED'\r\n| summarize flows=count() by is_drop, SourceNamespace, DestinationNamespace, src_workload_name, dst_workload_name, SourceIdentity, DestinationIdentity, dns_response_error, http_response_error\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// ignore hairpin traffic\r\n| where src_name != dst_name\r\n| extend is_good_request = not(is_drop or dns_response_error or http_response_error)\r\n| summarize\r\n    total_forwarded=sumif(flows, is_good_request),\r\n    total_dropped=sumif(flows, is_drop),\r\n    total_dns_errors=sumif(flows, dns_response_error),\r\n    total_http_errors=sumif(flows, http_response_error),\r\n    take_any(SourceNamespace),\r\n    take_any(DestinationNamespace),\r\n    take_any(src_workload_name),\r\n    take_any(dst_workload_name)\r\n    by src_name, dst_name\r\n| extend srcDst=strcat(src_name, ' -> ', dst_name)\r\n| project-rename edge_id=srcDst, edge_source=src_name, edge_target=dst_name\r\n| project-reorder edge_source, edge_target, total_forwarded, total_dropped, SourceNamespace, src_workload_name, DestinationNamespace, dst_workload_name\r\n| serialize id = row_number()\r\n| extend has_drop = total_dropped > 0\r\n// | extend has_forward = total_forwarded > 0\r\n| extend has_l7_error = total_dns_errors > 0 or total_http_errors > 0\r\n| project\r\n    id,\r\n    source = edge_source,\r\n    target = edge_target,\r\n    mainstat = strcat('forwarded: ', total_forwarded),\r\n    secondarystat = strcat('dropped: ', total_dropped, '. DNS errors: ', total_dns_errors, '. HTTP errors: ', total_http_errors),\r\n    highlighted = has_drop or has_l7_error,\r\n    // red/dotted if drops, orange/dashed if L7 errors, grey/solid if good\r\n    color = case(has_drop, '#F2495C', has_l7_error, '#FF9830', '#999'), // iff(has_drop, iff(has_forward, '#FF9830', '#F2495C'), '#999'),\r\n    strokeDasharray = case(has_drop, '5,5', has_l7_error, '12,12', ''), // iff(has_drop, iff(has_forward, '12,12', '5,5'), ''),\r\n    // dropped/error arrows have a thickness of 3+\r\n    // arrows get additional thickness for every 20 flows per second\r\n    thickness = iff(has_drop or has_l7_error, 3, 0) + min_of(3, max_of(1, (total_dropped + total_forwarded + total_dns_errors + total_http_errors) / seconds / 20))\r\n    // can add drilldown links in Grafana v11.3+\r\n    // SourceNamespace,\r\n    // DestinationNamespace,\r\n    // src_workload_name,\r\n    // dst_workload_name",
            "resources": [
              "$resourceURI"
            ],
            "resultFormat": "table",
            "timeColumn": "TimeGenerated"
          },
          "azureMonitor": {
            "allowedTimeGrainsMs": [],
            "timeGrain": "auto"
          },
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "hide": false,
          "queryType": "Azure Log Analytics",
          "refId": "edges"
        }
      ],
      "title": "",
      "transformations": [
        {
          "id": "renameByRegex",
          "options": {
            "regex": "mainstat",
            "renamePattern": "packets"
          }
        }
      ],
      "transparent": true,
      "type": "nodeGraph"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 24,
        "w": 5,
        "x": 19,
        "y": 7
      },
      "id": 378,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "This graph displays each workload (e.g. Deployment) that sent traffic during the time period.\n\nEach arrow draws a line from the requesting workload to the receiving workload.\nArrows are color-coded:\n- Grey, solid line: forwarded requests (no drops, no DNS/HTTP response errors).\n- Red, dotted line: dropped requests (dropped by NetworkPolicy, etc.).\n- Orange, dashed line: requests which received DNS/HTTP response errors.\n\nNOTE: in Grafana v10, both errors and drops are red/solid lines due to limitations.\n\nHover over a workload to highlight requests to/from that workload and to see the amount of flow logs for good requests, dropped requests, and response errors.",
        "mode": "markdown"
      },
      "pluginVersion": "11.6.3",
      "title": "",
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-azure-monitor-datasource",
        "uid": "${am_ds}"
      },
      "description": "Calculated as if Verdict=Forwarded. Unique requests counts the distinct tuples of source/destination IP and either the server port, DNS query, or HTTP method/url.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": true,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue"
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 5,
        "x": 0,
        "y": 11
      },
      "id": 321,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "11.6.3",
      "targets": [
        {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs =\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n);\r\nUnifiedFlowLogs\r\n| where Reply != 'true'\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// transformations for visualization\r\n| extend dst_port = toint(coalesce(Layer4.UDP.destination_port, Layer4.TCP.destination_port))\r\n| extend flowID=strcat(IP.source, \"#\", IP.destination, dst_port, Layer7.dns.query, Layer7.http.method, Layer7.http.url)\r\n| summarize total_flows=count(), unique_flows=dcount(flowID) by bin(TimeGenerated, rateInterval)\r\n",
            "resources": [
              "$resourceURI"
            ],
            "resultFormat": "time_series",
            "timeColumn": "TimeGenerated"
          },
          "azureMonitor": {
            "allowedTimeGrainsMs": [],
            "timeGrain": "auto"
          },
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "hide": false,
          "queryType": "Azure Log Analytics",
          "refId": "edges"
        }
      ],
      "title": "Requests (forwarded)",
      "transformations": [
        {
          "id": "renameByRegex",
          "options": {
            "regex": "total_flows",
            "renamePattern": "Total Flows"
          }
        },
        {
          "id": "renameByRegex",
          "options": {
            "regex": "unique_flows",
            "renamePattern": "Unique Requests"
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-azure-monitor-datasource",
        "uid": "${am_ds}"
      },
      "description": "Calculated as if Verdict=Forwarded. Unique responses counts the distinct tuples of source/destination IP and either the server port, DNS query, or HTTP method/url.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": true,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue"
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 5,
        "x": 0,
        "y": 15
      },
      "id": 327,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "11.6.3",
      "targets": [
        {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n);\r\nUnifiedFlowLogs\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// transformations for visualization\r\n| extend src_port = toint(coalesce(Layer4.UDP.source_port, Layer4.TCP.source_port))\r\n| extend flowID=strcat(IP.destination, \"#\", IP.source, src_port, Layer7.dns.query, Layer7.http.method, Layer7.http.url)\r\n| summarize total_flows=count(), unique_flows=dcount(flowID) by bin(TimeGenerated, rateInterval)\r\n",
            "resources": [
              "$resourceURI"
            ],
            "resultFormat": "time_series",
            "timeColumn": "TimeGenerated"
          },
          "azureMonitor": {
            "allowedTimeGrainsMs": [],
            "timeGrain": "auto"
          },
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "hide": false,
          "queryType": "Azure Log Analytics",
          "refId": "edges"
        }
      ],
      "title": "Responses (forwarded)",
      "transformations": [
        {
          "id": "renameByRegex",
          "options": {
            "regex": "total_flows",
            "renamePattern": "Total Flows"
          }
        },
        {
          "id": "renameByRegex",
          "options": {
            "regex": "unique_flows",
            "renamePattern": "Unique Responses"
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-azure-monitor-datasource",
        "uid": "${am_ds}"
      },
      "description": "Calculated as if Verdict=Dropped. Unique requests counts the distinct tuples of source/destination IP and either the server port, DNS query, or HTTP method/url.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": true,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red"
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 5,
        "x": 0,
        "y": 19
      },
      "id": 326,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "11.6.3",
      "targets": [
        {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| where Verdict == 'DROPPED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// transformations for visualization\r\n| extend dst_port = toint(coalesce(Layer4.UDP.destination_port, Layer4.TCP.destination_port))\r\n| extend flowID=strcat(IP.source, \"#\", IP.destination, dst_port, Layer7.dns.query, Layer7.http.method, Layer7.http.url)\r\n| summarize total_flows=count(), unique_flows=dcount(flowID) by bin(TimeGenerated, rateInterval)\r\n",
            "resources": [
              "$resourceURI"
            ],
            "resultFormat": "time_series",
            "timeColumn": "TimeGenerated"
          },
          "azureMonitor": {
            "allowedTimeGrainsMs": [],
            "timeGrain": "auto"
          },
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "hide": false,
          "queryType": "Azure Log Analytics",
          "refId": "edges"
        }
      ],
      "title": "Dropped Requests",
      "transformations": [
        {
          "id": "renameByRegex",
          "options": {
            "regex": "total_flows",
            "renamePattern": "Total Request Flows"
          }
        },
        {
          "id": "renameByRegex",
          "options": {
            "regex": "unique_flows",
            "renamePattern": "Unique Requests"
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-azure-monitor-datasource",
        "uid": "${am_ds}"
      },
      "description": "Calculated as if Verdict=Forwarded and Protocol=DNS. Unique responses counts the distinct tuples of source/destination IP and DNS query.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": true,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "orange"
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 5,
        "x": 0,
        "y": 23
      },
      "id": 380,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "11.6.3",
      "targets": [
        {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| where Reply\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.dns)\r\n| where Layer7.type == 'RESPONSE'\r\n| where toint(Layer7.dns.rcode) > 0\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// transformations for visualization\r\n| extend flowID=strcat(IP.source, \"#\", IP.destination, Layer7.dns.query)\r\n| summarize total_flows=count(), unique_flows=dcount(flowID) by bin(TimeGenerated, rateInterval)\r\n",
            "resources": [
              "$resourceURI"
            ],
            "resultFormat": "time_series",
            "timeColumn": "TimeGenerated"
          },
          "azureMonitor": {
            "allowedTimeGrainsMs": [],
            "timeGrain": "auto"
          },
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "hide": false,
          "queryType": "Azure Log Analytics",
          "refId": "edges"
        }
      ],
      "title": "DNS Response Errors",
      "transformations": [
        {
          "id": "renameByRegex",
          "options": {
            "regex": "total_flows",
            "renamePattern": "Total Request Flows"
          }
        },
        {
          "id": "renameByRegex",
          "options": {
            "regex": "unique_flows",
            "renamePattern": "Unique Responses"
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-azure-monitor-datasource",
        "uid": "${am_ds}"
      },
      "description": "Calculated as if Verdict=Forwarded and Protocol=HTTP. Unique responses counts the distinct set of tuples of source/destination IP and HTTP method/url.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": true,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "orange"
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 5,
        "x": 0,
        "y": 27
      },
      "id": 381,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "11.6.3",
      "targets": [
        {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, SourceIdentity, DestinationIdentity, Verdict, Layer7, Reply, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, IP\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| where Reply\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where toint(Layer7.http.code) >= 300\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// transformations for visualization\r\n| extend flowID=strcat(IP.source, \"#\", IP.destination, Layer7.dns.query)\r\n| summarize total_flows=count(), unique_flows=dcount(flowID) by bin(TimeGenerated, rateInterval)\r\n",
            "resources": [
              "$resourceURI"
            ],
            "resultFormat": "time_series",
            "timeColumn": "TimeGenerated"
          },
          "azureMonitor": {
            "allowedTimeGrainsMs": [],
            "timeGrain": "auto"
          },
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "hide": false,
          "queryType": "Azure Log Analytics",
          "refId": "edges"
        }
      ],
      "title": "HTTP Response Errors",
      "transformations": [
        {
          "id": "renameByRegex",
          "options": {
            "regex": "total_flows",
            "renamePattern": "Total Request Flows"
          }
        },
        {
          "id": "renameByRegex",
          "options": {
            "regex": "unique_flows",
            "renamePattern": "Unique Responses"
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "collapsed": true,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 31
      },
      "id": 322,
      "panels": [
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {},
            "overrides": []
          },
          "gridPos": {
            "h": 15,
            "w": 24,
            "x": 0,
            "y": 32
          },
          "id": 317,
          "options": {
            "dedupStrategy": "none",
            "enableInfiniteScrolling": false,
            "enableLogDetails": true,
            "prettifyLogMessage": false,
            "showCommonLabels": false,
            "showLabels": false,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": false
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\nUnifiedFlowLogs\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// verdict filter\r\n| extend verdictFilter = trim(\"'\", tostring(\"${verdict}\"))\r\n| where verdictFilter == \"ALL\" or Verdict == verdictFilter\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        Reply != 'true' and\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n    or\r\n    (\r\n        Reply and\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        Reply != 'true' and\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n    or\r\n    (\r\n        Reply and\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', SourcePodName),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', DestinationPodName),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// create client -> server identifier with L4 info\r\n| extend client = iff(Reply, dst_name, src_name)\r\n| extend server = iff(Reply, src_name, dst_name)\r\n| project-away src_name, dst_name\r\n| extend arrow = iff(Reply, ' <- ', ' -> ')\r\n| extend serverProto = iff(\r\n    isempty(Layer4),\r\n    '',\r\n    strcat(':',\r\n        iff(\r\n            Reply,\r\n            coalesce(Layer4.UDP.source_port, Layer4.TCP.source_port),\r\n            coalesce(Layer4.UDP.destination_port, Layer4.TCP.destination_port)\r\n        )\r\n    )\r\n)\r\n| extend clientServerID=strcat(client, arrow, server, serverProto)\r\n| project-away client, server, arrow, serverProto\r\n// Layer7\r\n| extend is_l7_response = Layer7.type == 'RESPONSE'\r\n| extend dns_rcode = Layer7.dns.rcode\r\n| extend dns_response = case(\r\n    not(is_l7_response) or isempty(Layer7.dns), '',\r\n    isempty(dns_rcode) or dns_rcode == 0, 'SUCCESS',\r\n    // dns_rcode == 1, 'ERROR(Format Error)',\r\n    // dns_rcode == 2, 'ERROR(Server Failure)',\r\n    dns_rcode == 3, 'WARN(non-existent domain)',\r\n    // dns_rcode == 4, 'ERROR(Not Implemented)',\r\n    // dns_rcode == 5, 'ERROR(Query Refused)',\r\n    // dns_rcode == 6, 'Name Exists when it should not',\r\n    // dns_rcode == 7, 'RR Set Exists when it should not',\r\n    // dns_rcode == 8, 'RR Set that should exist does not',\r\n    // dns_rcode == 9, 'ERROR(Authority/Authorization)',\r\n    // dns_rcode == 10, 'Name not contained in zone',\r\n    // dns_rcode == 11, 'DSO-TYPE Not Implemented',\r\n    // dns_rcode >= 12 and dns_rcode <= 15, 'Unassigned',\r\n    // dns_rcode == 16, 'Bad OPT Version',\r\n    // dns_rcode == 17, 'TSIG Signature Failure',\r\n    // dns_rcode == 18, 'Key not recognized',\r\n    // dns_rcode == 19, 'Signature out of time window',\r\n    // dns_rcode == 20, 'Bad TKEY Mode',\r\n    // dns_rcode == 21, 'Duplicate key name',\r\n    // dns_rcode == 22, 'Algorithm not supported',\r\n    // dns_rcode == 23, 'Bad Truncation / Bad or missing Server Cookie',\r\n    // 'ERROR(Other)'\r\n    'ERROR'\r\n)\r\n| project-away dns_rcode\r\n| project-rename response=dns_response\r\n| extend http_code = Layer7.http.code\r\n| extend http_response = case(\r\n    not(is_l7_response) or isempty(Layer7.http), '',\r\n    isempty(http_code) or http_code < 300, 'SUCCESS',\r\n    'ERROR'\r\n)\r\n| project-away http_code, is_l7_response\r\n| extend response=coalesce(response, http_response)\r\n| extend query_or_endpoint = coalesce(Layer7.dns.query, Layer7.http.url) // iff(isempty(Layer7.http.url), '', strcat(Layer7.http.method, ' ', Layer7.http.url)))\r\n// append L7 query/endpoint to clientServerID\r\n| extend clientServerID = iff(isempty(query_or_endpoint), clientServerID, strcat(clientServerID, ' [', query_or_endpoint, ']'))\r\n| project-away query_or_endpoint\r\n// transformations for logs visualization\r\n| project-reorder TimeGenerated,\r\n    SourceNamespace, SourcePodName, SourceWorkloads, SourceIdentity,\r\n    DestinationNamespace, DestinationPodName, DestinationWorkloads, DestinationIdentity,\r\n    Verdict, DropReason, TrafficDirection, TraceObservationPoint, Reply, Type, FlowType, EventType,\r\n    IP, Layer4, Layer7, NodeName, Policies, AdditionalFlowData,\r\n    Service,\r\n    SourceClusterName, SourceSystem, DestinationClusterName,\r\n    UUID,\r\n    TenantId\r\n| project-rename ['Time']=TimeGenerated\r\n// format examples:\r\n// \"[TCP] [ERROR(dropped)] client -> server:80\"\r\n// \"[DNS] [WARN(non-existent domain)] client -> server [bing.com]\"\r\n| extend dropped=iff(Verdict == 'DROPPED', '[ERROR(dropped)] ', '')\r\n| extend response = iff(isempty(response), '', strcat('[', response, '] '))\r\n| extend TitleMessage = strcat('[', proto, '] ',  dropped, response, clientServerID)\r\n| project-away dropped, response\r\n| project-reorder Time, TitleMessage\r\n| take 1000\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "logs",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "All Flow Logs (first 1000)",
          "transformations": [
            {
              "id": "renameByRegex",
              "options": {
                "regex": "total_flows",
                "renamePattern": "Total Flows"
              }
            },
            {
              "id": "renameByRegex",
              "options": {
                "regex": "unique_flows",
                "renamePattern": "Unique Flows"
              }
            }
          ],
          "transparent": true,
          "type": "logs"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Includes drops or DNS/HTTP response errors remaining after filtering by dashboard variables.",
          "fieldConfig": {
            "defaults": {},
            "overrides": []
          },
          "gridPos": {
            "h": 15,
            "w": 24,
            "x": 0,
            "y": 52
          },
          "id": 389,
          "options": {
            "dedupStrategy": "none",
            "enableInfiniteScrolling": false,
            "enableLogDetails": true,
            "prettifyLogMessage": false,
            "showCommonLabels": false,
            "showLabels": false,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": false
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n    (\r\n        RetinaNetworkFlowLogs\r\n    ),\r\n    (\r\n        ContainerNetworkLogs\r\n    );\r\nUnifiedFlowLogs\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// verdict filter\r\n| extend verdictFilter = trim(\"'\", tostring(\"${verdict}\"))\r\n| where verdictFilter == \"ALL\" or Verdict == verdictFilter\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// error filter\r\n| extend http_code = Layer7.http.code\r\n| extend dns_rcode = Layer7.dns.rcode\r\n| where Verdict == 'DROPPED' or (\r\n    Layer7.type == 'RESPONSE' and (\r\n        (proto == 'HTTP' and toint(http_code) >= 300)\r\n        or\r\n        (proto == 'DNS' and toint(dns_rcode) > 0)\r\n    )\r\n)\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        Reply != 'true' and\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n    or\r\n    (\r\n        Reply and\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        Reply != 'true' and\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n    or\r\n    (\r\n        Reply and\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', SourcePodName),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', DestinationPodName),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// create client -> server identifier with L4 info\r\n| extend client = iff(Reply, dst_name, src_name)\r\n| extend server = iff(Reply, src_name, dst_name)\r\n| project-away src_name, dst_name\r\n| extend arrow = iff(Reply, ' <- ', ' -> ')\r\n| extend serverProto = iff(\r\n    isempty(Layer4),\r\n    '',\r\n    strcat(':',\r\n        iff(\r\n            Reply,\r\n            coalesce(Layer4.UDP.source_port, Layer4.TCP.source_port),\r\n            coalesce(Layer4.UDP.destination_port, Layer4.TCP.destination_port)\r\n        )\r\n    )\r\n)\r\n| extend clientServerID=strcat(client, arrow, server, serverProto)\r\n| project-away client, server, arrow, serverProto\r\n// Layer7\r\n| extend is_l7_response = Layer7.type == 'RESPONSE'\r\n| extend dns_response = case(\r\n    not(is_l7_response) or isempty(Layer7.dns), '',\r\n    isempty(dns_rcode) or dns_rcode == 0, 'SUCCESS',\r\n    // dns_rcode == 1, 'ERROR(Format Error)',\r\n    // dns_rcode == 2, 'ERROR(Server Failure)',\r\n    dns_rcode == 3, 'WARN(non-existent domain)',\r\n    // dns_rcode == 4, 'ERROR(Not Implemented)',\r\n    // dns_rcode == 5, 'ERROR(Query Refused)',\r\n    // dns_rcode == 6, 'Name Exists when it should not',\r\n    // dns_rcode == 7, 'RR Set Exists when it should not',\r\n    // dns_rcode == 8, 'RR Set that should exist does not',\r\n    // dns_rcode == 9, 'ERROR(Authority/Authorization)',\r\n    // dns_rcode == 10, 'Name not contained in zone',\r\n    // dns_rcode == 11, 'DSO-TYPE Not Implemented',\r\n    // dns_rcode >= 12 and dns_rcode <= 15, 'Unassigned',\r\n    // dns_rcode == 16, 'Bad OPT Version',\r\n    // dns_rcode == 17, 'TSIG Signature Failure',\r\n    // dns_rcode == 18, 'Key not recognized',\r\n    // dns_rcode == 19, 'Signature out of time window',\r\n    // dns_rcode == 20, 'Bad TKEY Mode',\r\n    // dns_rcode == 21, 'Duplicate key name',\r\n    // dns_rcode == 22, 'Algorithm not supported',\r\n    // dns_rcode == 23, 'Bad Truncation / Bad or missing Server Cookie',\r\n    // 'ERROR(Other)'\r\n    'ERROR'\r\n)\r\n| project-away dns_rcode\r\n| project-rename response=dns_response\r\n| extend http_response = case(\r\n    not(is_l7_response) or isempty(Layer7.http), '',\r\n    isempty(http_code) or http_code < 300, 'SUCCESS',\r\n    'ERROR'\r\n)\r\n| project-away http_code, is_l7_response\r\n| extend response=coalesce(response, http_response)\r\n| extend query_or_endpoint = coalesce(Layer7.dns.query, Layer7.http.url) // iff(isempty(Layer7.http.url), '', strcat(Layer7.http.method, ' ', Layer7.http.url)))\r\n// append L7 query/endpoint to clientServerID\r\n| extend clientServerID = iff(isempty(query_or_endpoint), clientServerID, strcat(clientServerID, ' [', query_or_endpoint, ']'))\r\n| project-away query_or_endpoint\r\n// transformations for logs visualization\r\n| project-reorder TimeGenerated,\r\n    SourceNamespace, SourcePodName, SourceWorkloads, SourceIdentity,\r\n    DestinationNamespace, DestinationPodName, DestinationWorkloads, DestinationIdentity,\r\n    Verdict, DropReason, TrafficDirection, TraceObservationPoint, Reply, Type, FlowType, EventType,\r\n    IP, Layer4, Layer7, NodeName, PacketsReceived, PacketsSent, Policies, AdditionalFlowData,\r\n    Service,\r\n    SourceClusterName, SourceSystem, DestinationClusterName,\r\n    UUID,\r\n    TenantId\r\n| project-rename ['Time']=TimeGenerated\r\n// format examples:\r\n// \"[TCP] [ERROR(dropped)] client -> server:80\"\r\n// \"[DNS] [WARN(non-existent domain)] client -> server [bing.com]\"\r\n| extend dropped=iff(Verdict == 'DROPPED', '[ERROR(dropped)] ', '')\r\n| extend response = iff(isempty(response), '', strcat('[', response, '] '))\r\n| extend TitleMessage = strcat('[', proto, '] ',  dropped, response, clientServerID)\r\n| project-away dropped, response\r\n| project-reorder Time, TitleMessage\r\n| take 1000\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "logs",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Error Logs (first 1000)",
          "transformations": [
            {
              "id": "renameByRegex",
              "options": {
                "regex": "total_flows",
                "renamePattern": "Total Flows"
              }
            },
            {
              "id": "renameByRegex",
              "options": {
                "regex": "unique_flows",
                "renamePattern": "Unique Flows"
              }
            }
          ],
          "transparent": true,
          "type": "logs"
        }
      ],
      "title": "Flow Logs",
      "type": "row"
    },
    {
      "collapsed": true,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 32
      },
      "id": 241,
      "panels": [
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=All&var-dst_workload=All&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 0,
            "y": 98
          },
          "id": 240,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// requests only\r\n| where Reply != 'true'\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    SourceNamespace,\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    DestinationNamespace,\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(src_name, ' -> ', dst_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, DestinationNamespace\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top Requests (forwarded)",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Dropped.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-verdict=DROPPED&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=All&var-dst_workload=All&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 6,
            "y": 98
          },
          "id": 373,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| where Verdict == 'DROPPED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    SourceNamespace,\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    DestinationNamespace,\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(src_name, ' -> ', dst_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, DestinationNamespace\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top Dropped Requests",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded and Protocol=DNS.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=All&var-dst_workload=All&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 12,
            "y": 98
          },
          "id": 372,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// responses only\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.dns)\r\n| where Layer7.type == 'RESPONSE'\r\n| where toint(Layer7.dns.rcode) > 0\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    SourceNamespace,\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    DestinationNamespace,\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(dst_name, ' <- ', src_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, DestinationNamespace\r\n| project-rename Time=TimeGenerated\r\n\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top DNS Response Errors",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded and Protocol=HTTP.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=All&var-dst_workload=All&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 18,
            "y": 98
          },
          "id": 252,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// responses only\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.http)\r\n| where Layer7.type == 'RESPONSE'\r\n| where toint(Layer7.http.code) >= 300\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    SourceNamespace,\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    DestinationNamespace,\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(dst_name, ' <- ', src_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, DestinationNamespace\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top HTTP Response Errors",
          "transparent": true,
          "type": "timeseries"
        }
      ],
      "title": "Top Namespaces",
      "type": "row"
    },
    {
      "collapsed": true,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 33
      },
      "id": 266,
      "panels": [
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 0,
            "y": 99
          },
          "id": 374,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n);\r\nUnifiedFlowLogs\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// requests only\r\n| where Reply != 'true'\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, src_workload_name, dst_workload_name, SourceIdentity, DestinationIdentity, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(src_name, ' -> ', dst_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, src_workload_name, DestinationNamespace, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n// | sort by Time asc\r\n\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top Requests (forwarded)",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Dropped.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-verdict=DROPPED&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 6,
            "y": 99
          },
          "id": 382,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| where Verdict == 'DROPPED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, src_workload_name, dst_workload_name, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(src_name, ' -> ', dst_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, src_workload_name, DestinationNamespace, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top Dropped Requests",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded and Protocol=DNS.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 12,
            "y": 99
          },
          "id": 383,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// responses only\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.dns)\r\n| where Layer7.type == 'RESPONSE'\r\n| where toint(Layer7.dns.rcode) > 0\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, src_workload_name, dst_workload_name, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(dst_name, ' <- ', src_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, src_workload_name, DestinationNamespace, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top DNS Response Errors",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded and Protocol=HTTP.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 18,
            "y": 99
          },
          "id": 384,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// responses only\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.http)\r\n| where Layer7.type == 'RESPONSE'\r\n| where toint(Layer7.http.code) >= 300\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, src_workload_name, dst_workload_name, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(dst_name, ' <- ', src_name)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, DestinationNamespace, src_workload_name, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top HTTP Response Errors",
          "transparent": true,
          "type": "timeseries"
        }
      ],
      "title": "Top Workloads",
      "type": "row"
    },
    {
      "collapsed": true,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 34
      },
      "id": 375,
      "panels": [
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded. Includes TCP and UDP flows if Protocol=All. Otherwise, includes the selected Protocol only.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 0,
            "y": 114
          },
          "id": 376,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n);\r\nUnifiedFlowLogs\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// requests only\r\n| where Reply != 'true'\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// proto filter\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| extend all_proto = protocolFilter == \"ALL\"\r\n| where (isnotempty(Layer4.TCP) and (all_proto or protocolFilter == \"TCP\")) or (isnotempty(Layer4.UDP) and (all_proto or protocolFilter == \"UDP\"))\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| extend dst_port = toint(coalesce(Layer4.UDP.destination_port, Layer4.TCP.destination_port))\r\n| where isnotempty(dst_port)\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, src_workload_name, dst_workload_name, SourceIdentity, DestinationIdentity, dst_port, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(src_name, ' -> ', dst_name, ':', dst_port)\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, src_workload_name, DestinationNamespace, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top Requests (TCP and/or UDP) (forwarded)",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Dropped.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-verdict=DROPPED&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 6,
            "y": 114
          },
          "id": 390,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, Verdict, SourceIdentity, DestinationIdentity, Layer4, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| where Verdict == 'DROPPED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n| extend protocolFilter = trim(\"'\", tostring(\"${protocol}\"))\r\n| where protocolFilter == \"ALL\" or proto == protocolFilter\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| extend dst_port = toint(coalesce(Layer4.UDP.destination_port, Layer4.TCP.destination_port))\r\n| extend endpoint = tostring(coalesce(Layer7.dns.query, Layer7.http.url))\r\n| where isnotempty(dst_port) or isnotempty(endpoint)\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, src_workload_name, dst_workload_name, SourceIdentity, DestinationIdentity, dst_port, endpoint, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend port_str = iff(isempty(dst_port), '', strcat(':', dst_port))\r\n| extend endpoint_str = iff(isempty(endpoint),  '', strcat(' [', endpoint, ']'))\r\n| extend srcDst=strcat(src_name, ' -> ', dst_name, port_str, endpoint_str)\r\n| project-away src_name, dst_name, port_str, endpoint_str\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, src_workload_name, DestinationNamespace, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top Dropped Requests",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded and Protocol=DNS.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 12,
            "y": 114
          },
          "id": 391,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// responses only\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.dns)\r\n| where Layer7.type == 'RESPONSE'\r\n| where toint(Layer7.dns.rcode) > 0\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| extend endpoint = tostring(Layer7.dns.query)\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, src_workload_name, dst_workload_name, endpoint, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(dst_name, ' <- ', src_name, ' [', endpoint, ']')\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, src_workload_name, DestinationNamespace, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top DNS Response Errors",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "Calculated as if Verdict=Forwarded and Protocol=HTTP.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Flow Logs",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "displayName": "${__field.labels.srcDst}",
              "links": [
                {
                  "targetBlank": false,
                  "title": "Filter on source/destination namespace and workload",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-src_ns=${__field.labels.SourceNamespace}&var-dst_ns=${__field.labels.DestinationNamespace}&var-src_workload=${__field.labels.src_workload_name}&var-dst_workload=${__field.labels.dst_workload_name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${protocol:queryparam}&${inclusions:queryparam}"
                }
              ],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 18,
            "y": 114
          },
          "id": 392,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "let ranks_to_include = 5;\r\n// 20 equal parts\r\nlet rateInterval =  1s * max_of(1.0, toreal(datetime_diff('second', $__timeTo(), $__timeFrom())) / 20.0);\r\n// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project TimeGenerated, Reply, SourceIdentity, DestinationIdentity, Verdict, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nUnifiedFlowLogs\r\n// responses only\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.http)\r\n| where Layer7.type == 'RESPONSE'\r\n| where toint(Layer7.http.code) >= 300\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| extend endpoint = tostring(Layer7.http.url)\r\n| summarize flows=count() by SourceNamespace, DestinationNamespace, SourceIdentity, DestinationIdentity, src_workload_name, dst_workload_name, endpoint, bin(TimeGenerated, rateInterval)\r\n| sort by TimeGenerated asc, flows desc\r\n| serialize rank=row_cumsum(1, TimeGenerated != prev(TimeGenerated))\r\n| where rank <= ranks_to_include\r\n// source: replace (empty) pod name with reserved identity name\r\n| extend src_name = iff(\r\n    isnotempty(SourceNamespace), // not(isempty(SourceIdentity) or toint(SourceIdentity) <= 11)\r\n    strcat(SourceNamespace, '/', src_workload_name),\r\n    case(\r\n        isempty(SourceIdentity) or SourceIdentity <= 0, 'unknown',\r\n        SourceIdentity == 1, 'host',\r\n        SourceIdentity == 2, 'world',\r\n        SourceIdentity == 3, 'unmanaged',\r\n        // SourceIdentity == 4, 'health',\r\n        // SourceIdentity == 5, 'init',\r\n        SourceIdentity == 6, 'remote-node',\r\n        SourceIdentity == 7, 'api-server',\r\n        // SourceIdentity == 8, 'identity-ingress',\r\n        // SourceIdentity == 9, 'world-ipv4',\r\n        // SourceIdentity == 10, 'world-ipv6',\r\n        // SourceIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n// destination: replace (empty) pod name with reserved identity name\r\n| extend dst_name = iff(\r\n    isnotempty(DestinationNamespace), // not(isempty(DestinationIdentity) or toint(DestinationIdentity) <= 11)\r\n    strcat(DestinationNamespace, '/', dst_workload_name),\r\n    case(\r\n        isempty(DestinationIdentity) or DestinationIdentity <= 0, 'unknown',\r\n        DestinationIdentity == 1, 'host',\r\n        DestinationIdentity == 2, 'world',\r\n        DestinationIdentity == 3, 'unmanaged',\r\n        // DestinationIdentity == 4, 'health',\r\n        // DestinationIdentity == 5, 'init',\r\n        DestinationIdentity == 6, 'remote-node',\r\n        DestinationIdentity == 7, 'api-server',\r\n        // DestinationIdentity == 8, 'identity-ingress',\r\n        // DestinationIdentity == 9, 'world-ipv4',\r\n        // DestinationIdentity == 10, 'world-ipv6',\r\n        // DestinationIdentity == 11, 'encrypted-overlay',\r\n        'other-reserved'\r\n    )\r\n)\r\n| extend srcDst=strcat(dst_name, ' <- ', src_name, ' [', endpoint, ']')\r\n| project-away src_name, dst_name\r\n| summarize flows=sum(flows), take_any(SourceNamespace), take_any(DestinationNamespace), take_any(src_workload_name), take_any(dst_workload_name) by srcDst, TimeGenerated\r\n| project-reorder TimeGenerated, srcDst, flows, SourceNamespace, DestinationNamespace, src_workload_name, dst_workload_name\r\n| project-rename Time=TimeGenerated\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "time_series",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Top HTTP Response Errors",
          "transparent": true,
          "type": "timeseries"
        }
      ],
      "title": "Top Workloads by Port/Query",
      "type": "row"
    },
    {
      "collapsed": true,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 35
      },
      "id": 356,
      "panels": [
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "fixedColor": "blue",
                "mode": "shades"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "links": [
                {
                  "title": "",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-protocol=${__field.name}&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${verdict:queryparam}&${src_ns:queryparam}&${dst_ns:queryparam}&${src_workload:queryparam}&${dst_workload:queryparam}&${inclusions:queryparam}\r\n"
                }
              ],
              "mappings": [],
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "TCP"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "dark-blue",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "UDP"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "dark-green",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "DNS"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "yellow",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "other"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "orange",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 5,
            "w": 6,
            "x": 0,
            "y": 36
          },
          "id": 355,
          "options": {
            "legend": {
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, SourceIdentity, DestinationIdentity, Reply, Verdict, Layer4, Layer7\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, SourceIdentity, DestinationIdentity, Reply, Verdict, Layer4, Layer7\r\n);\r\nUnifiedFlowLogs\r\n| where Reply != 'true'\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| summarize flows=count() by proto\r\n\r\n\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "table",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Requests (forwarded)",
          "transformations": [
            {
              "id": "rowsToFields",
              "options": {}
            }
          ],
          "transparent": true,
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "fixedColor": "red",
                "mode": "shades"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "links": [
                {
                  "title": "",
                  "url": "d/${__dashboard.uid}/kubernetes-networking-flow-logs?${__url_time_range}&var-protocol=${__field.name}&var-verdict=DROPPED&${datasource:queryparam}&${sub:queryparam}&${rg:queryparam}&${cluster:queryparam}&${src_ns:queryparam}&${dst_ns:queryparam}&${src_workload:queryparam}&${dst_workload:queryparam}&${inclusions:queryparam}\r\n"
                }
              ],
              "mappings": [],
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "TCP"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "dark-blue",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "UDP"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "dark-green",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "DNS"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "yellow",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "other"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "orange",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 5,
            "w": 6,
            "x": 6,
            "y": 36
          },
          "id": 377,
          "options": {
            "legend": {
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName, SourceIdentity, DestinationIdentity, Verdict, Layer4, Layer7\r\n);\r\nUnifiedFlowLogs\r\n// verdict filter\r\n| where Verdict == 'DROPPED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto\r\n| extend proto = case(\r\n    isnotempty(Layer4.TCP), 'TCP',\r\n    isnotempty(Layer4.UDP), 'UDP',\r\n    isnotempty(Layer7.dns), 'DNS',\r\n    isnotempty(Layer7.http), 'HTTP',\r\n    'other'\r\n)\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or src_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or dst_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| summarize flows=count() by proto\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "table",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "Dropped Requests",
          "transformations": [
            {
              "id": "rowsToFields",
              "options": {}
            }
          ],
          "transparent": true,
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "fixedColor": "red",
                "mode": "palette-classic-by-name"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "mappings": [],
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "Success"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "green",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 5,
            "w": 6,
            "x": 12,
            "y": 36
          },
          "id": 379,
          "options": {
            "legend": {
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project Reply, SourceIdentity, DestinationIdentity, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project Reply, SourceIdentity, DestinationIdentity, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nlet results = UnifiedFlowLogs\r\n| where Reply\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.dns)\r\n| where Layer7.type == 'RESPONSE'\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| extend dns_rcode = toint(Layer7.dns.rcode)\r\n| summarize count() by dns_rcode\r\n| extend dns_response = case(\r\n    isempty(dns_rcode) or dns_rcode == 0, 'Success',\r\n    dns_rcode == 1, 'Format Error',\r\n    dns_rcode == 2, 'Server Failure',\r\n    dns_rcode == 3, 'Non-Existent Domain',\r\n    dns_rcode == 4, 'Not Implemented',\r\n    dns_rcode == 5, 'Query Refused',\r\n    dns_rcode == 6, 'Name Exists when it should not',\r\n    dns_rcode == 7, 'RR Set Exists when it should not',\r\n    dns_rcode == 8, 'RR Set that should exist does not',\r\n    dns_rcode == 9, 'Authority/Authorization',\r\n    dns_rcode == 10, 'Name not contained in zone',\r\n    dns_rcode == 11, 'DSO-TYPE Not Implemented',\r\n    dns_rcode >= 12 and dns_rcode <= 15, 'Unassigned',\r\n    dns_rcode == 16, 'Bad OPT Version',\r\n    dns_rcode == 17, 'TSIG Signature Failure',\r\n    dns_rcode == 18, 'Key not recognized',\r\n    dns_rcode == 19, 'Signature out of time window',\r\n    dns_rcode == 20, 'Bad TKEY Mode',\r\n    dns_rcode == 21, 'Duplicate key name',\r\n    dns_rcode == 22, 'Algorithm not supported',\r\n    dns_rcode == 23, 'Bad Truncation / Bad or missing Server Cookie',\r\n    'Other Error'\r\n)\r\n| project-away dns_rcode;\r\n// Ensure we always return at least one row\r\nresults\r\n| union (print dns_response = \"No DNS Data\", count_ = 0 | where toscalar(results | count) == 0)\r\n",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "table",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "DNS Responses by Error",
          "transformations": [
            {
              "id": "rowsToFields",
              "options": {}
            }
          ],
          "transparent": true,
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "grafana-azure-monitor-datasource",
            "uid": "${am_ds}"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic-by-name"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "mappings": [],
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 5,
            "w": 6,
            "x": 18,
            "y": 36
          },
          "id": 371,
          "options": {
            "legend": {
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "hideZeros": false,
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "11.6.3",
          "targets": [
            {
              "azureLogAnalytics": {
                "dashboardTime": true,
                "query": "// 2=world, 1=host, 6=remote-node\r\nlet exclusions_str = set_difference(dynamic(['2', '1', '6']), split(replace_string(replace_string(\"${inclusions}\", \"'\", \"\"), '-1', '1,6'), ','));\r\nlet items = range i from 0 to (array_length(exclusions_str)-1) step 1\r\n| extend x = toint(exclusions_str[i])\r\n| summarize make_list(x, 10)\r\n;\r\nlet exclusions = toscalar(items);\r\n// Schema harmonization for both table types\r\nlet UnifiedFlowLogs=\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project Reply, Verdict, SourceIdentity, DestinationIdentity, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project Reply, Verdict, SourceIdentity, DestinationIdentity, Layer7, SourceNamespace, DestinationNamespace, SourcePodName, DestinationPodName\r\n);\r\nlet results = UnifiedFlowLogs\r\n| where Reply\r\n// verdict filter\r\n| where Verdict == 'FORWARDED'\r\n// filter out world/host if needed\r\n| where SourceIdentity !in (exclusions) and DestinationIdentity !in (exclusions)\r\n// proto filter\r\n| where isnotempty(Layer7.http)\r\n| where Layer7.type == 'RESPONSE'\r\n// filter by source and destination\r\n| extend src_workload_name = replace_regex(SourcePodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| extend dst_workload_name = replace_regex(DestinationPodName, @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| where \"${src_ns:json}\" == \"ALL\" or\r\n    (\r\n        DestinationNamespace == \"${src_ns:json}\" and (\r\n            \"${src_workload:json}\" == 'ALL' or dst_workload_name == \"${src_workload:json}\"\r\n        )\r\n    )\r\n| where \"${dst_ns:json}\" == \"ALL\" or\r\n    (\r\n        SourceNamespace == \"${dst_ns:json}\" and (\r\n            \"${dst_workload:json}\" == 'ALL' or src_workload_name == \"${dst_workload:json}\"\r\n        )\r\n    )\r\n| project-away src_workload_name, dst_workload_name\r\n| extend http_code = toint(Layer7.http.code)\r\n| summarize count() by http_code;\r\n// Ensure we always return at least one row to prevent transformation errors\r\nresults\r\n| union (print http_code = \"No HTTP Data\", count_ = 0 | where toscalar(results | count) == 0)",
                "resources": [
                  "$resourceURI"
                ],
                "resultFormat": "table",
                "timeColumn": "TimeGenerated"
              },
              "azureMonitor": {
                "allowedTimeGrainsMs": [],
                "timeGrain": "auto"
              },
              "datasource": {
                "type": "grafana-azure-monitor-datasource",
                "uid": "${am_ds}"
              },
              "hide": false,
              "queryType": "Azure Log Analytics",
              "refId": "edges"
            }
          ],
          "title": "HTTP Responses by Error",
          "transformations": [
            {
              "id": "rowsToFields",
              "options": {}
            }
          ],
          "transparent": true,
          "type": "piechart"
        }
      ],
      "title": "Protocol Summary",
      "type": "row"
    }
  ],
  "preload": false,
  "refresh": "",
  "schemaVersion": 41,
  "tags": [
    "k8s:network-observability",
    "Azure-networking",
    "Azure-managed"
  ],
  "templating": {
    "list": [
      {
        "current": {
          "text": "Azure Monitor",
          "value": "azure-monitor-oob"
        },
        "includeAll": false,
        "label": "Data Source",
        "name": "am_ds",
        "options": [],
        "query": "grafana-azure-monitor-datasource",
        "refresh": 1,
        "regex": "",
        "type": "datasource"
      },
      {
        "current": {
          "text": "ME-MngEnvMCAP032060-omerfeldman-1",
          "value": "20c82397-5937-4d15-8f69-f8e9a37bc317"
        },
        "datasource": {
          "type": "grafana-azure-monitor-datasource",
          "uid": "${am_ds}"
        },
        "definition": "",
        "includeAll": false,
        "label": "Subscription",
        "name": "sub",
        "options": [],
        "query": {
          "azureLogAnalytics": {
            "query": "",
            "resources": []
          },
          "queryType": "Azure Subscriptions",
          "refId": "A"
        },
        "refresh": 1,
        "regex": "",
        "sort": 1,
        "type": "query"
      },
      {
        "current": {
          "text": "cilium-test",
          "value": "cilium-test"
        },
        "datasource": {
          "type": "grafana-azure-monitor-datasource",
          "uid": "${am_ds}"
        },
        "definition": "",
        "includeAll": false,
        "label": "Resource Group",
        "name": "rg",
        "options": [],
        "query": {
          "azureResourceGraph": {
            "query": "resources\r\n| where type =~ \"microsoft.containerservice/managedclusters\"\r\n| distinct resourceGroup\r\n"
          },
          "queryType": "Azure Resource Graph",
          "refId": "A",
          "subscription": "$sub",
          "subscriptions": [
            "$sub"
          ]
        },
        "refresh": 1,
        "regex": "",
        "type": "query"
      },
      {
        "current": {
          "text": "cilium-test",
          "value": "cilium-test"
        },
        "datasource": {
          "type": "grafana-azure-monitor-datasource",
          "uid": "${am_ds}"
        },
        "definition": "",
        "includeAll": false,
        "label": "Cluster",
        "name": "cluster",
        "options": [],
        "query": {
          "azureLogAnalytics": {
            "query": "",
            "resources": []
          },
          "azureResourceGraph": {
            "query": "Resources\r\n| where type == 'microsoft.containerservice/managedclusters'\r\n| where resourceGroup =~ '${rg}'\r\n| project name"
          },
          "queryType": "Azure Resource Graph",
          "refId": "A",
          "subscriptions": [
            "$sub"
          ]
        },
        "refresh": 1,
        "regex": "",
        "sort": 1,
        "type": "query"
      },
      {
        "current": {
          "text": "/subscriptions/20c82397-5937-4d15-8f69-f8e9a37bc317/resourceGroups/cilium-test/providers/Microsoft.ContainerService/managedClusters/cilium-test",
          "value": "/subscriptions/20c82397-5937-4d15-8f69-f8e9a37bc317/resourceGroups/cilium-test/providers/Microsoft.ContainerService/managedClusters/cilium-test"
        },
        "description": "",
        "hide": 2,
        "includeAll": false,
        "label": "resourceURI",
        "name": "resourceURI",
        "options": [
          {
            "selected": true,
            "text": "/subscriptions/20c82397-5937-4d15-8f69-f8e9a37bc317/resourceGroups/cilium-test/providers/Microsoft.ContainerService/managedClusters/cilium-test",
            "value": "/subscriptions/20c82397-5937-4d15-8f69-f8e9a37bc317/resourceGroups/cilium-test/providers/Microsoft.ContainerService/managedClusters/cilium-test"
          }
        ],
        "query": "/subscriptions/$sub/resourceGroups/$rg/providers/Microsoft.ContainerService/managedClusters/$cluster",
        "type": "custom"
      },
      {
        "allValue": "ALL",
        "current": {
          "text": "$__all",
          "value": "$__all"
        },
        "description": "",
        "includeAll": true,
        "label": "Verdict",
        "name": "verdict",
        "options": [
          {
            "selected": false,
            "text": "Forwarded",
            "value": "FORWARDED"
          },
          {
            "selected": false,
            "text": "Dropped",
            "value": "DROPPED"
          }
        ],
        "query": "Forwarded : FORWARDED, Dropped : DROPPED",
        "type": "custom"
      },
      {
        "allValue": "ALL",
        "current": {
          "text": "$__all",
          "value": "$__all"
        },
        "description": "",
        "includeAll": true,
        "label": "Protocol",
        "name": "protocol",
        "options": [
          {
            "selected": false,
            "text": "TCP",
            "value": "TCP"
          },
          {
            "selected": false,
            "text": "UDP",
            "value": "UDP"
          },
          {
            "selected": false,
            "text": "DNS",
            "value": "DNS"
          },
          {
            "selected": false,
            "text": "HTTP",
            "value": "HTTP"
          }
        ],
        "query": "TCP, UDP, DNS, HTTP",
        "type": "custom"
      },
      {
        "allValue": "ALL",
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "grafana-azure-monitor-datasource",
          "uid": "${am_ds}"
        },
        "definition": "",
        "includeAll": true,
        "label": "Source Namespace",
        "name": "src_ns",
        "options": [],
        "query": {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// Schema harmonization for both table types\r\nlet UnifiedFlowLogs =\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project SourceNamespace\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project SourceNamespace\r\n);\r\nUnifiedFlowLogs\r\n| distinct tostring(SourceNamespace)\r\n| where SourceNamespace != ''\r\n",
            "resources": [
              "$resourceURI"
            ],
            "timeColumn": "TimeGenerated"
          },
          "queryType": "Azure Log Analytics",
          "refId": "A"
        },
        "refresh": 2,
        "regex": "",
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "ALL",
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "grafana-azure-monitor-datasource",
          "uid": "${am_ds}"
        },
        "definition": "",
        "includeAll": true,
        "label": "Destination Namespace",
        "name": "dst_ns",
        "options": [],
        "query": {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// Schema harmonization for both table types\r\nlet UnifiedFlowLogs =\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project DestinationNamespace\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project DestinationNamespace\r\n);\r\nUnifiedFlowLogs\r\n| distinct tostring(DestinationNamespace)\r\n| where DestinationNamespace != ''",
            "resources": [
              "$resourceURI"
            ],
            "timeColumn": "TimeGenerated"
          },
          "queryType": "Azure Log Analytics",
          "refId": "A"
        },
        "refresh": 2,
        "regex": "",
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "ALL",
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "grafana-azure-monitor-datasource",
          "uid": "${am_ds}"
        },
        "definition": "",
        "includeAll": true,
        "label": "Source Workload",
        "name": "src_workload",
        "options": [],
        "query": {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// Schema harmonization for both table types\r\nlet UnifiedFlowLogs =\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project SourcePodName, SourceNamespace\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project SourcePodName, SourceNamespace\r\n);\r\nUnifiedFlowLogs\r\n// hack so as to not query the table if src_ns == ALL\r\n| extend podname = iff(\"${src_ns:json}\" == 'ALL', 'ALL', SourcePodName)\r\n| extend ns = iff(\"${src_ns:json}\" == 'ALL', 'ALL', SourceNamespace)\r\n| summarize count() by podname, ns\r\n| where ns == \"${src_ns:json}\"\r\n| where podname != 'ALL' and isnotempty(podname)\r\n| extend workload_name = replace_regex(tostring(podname), @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| distinct workload_name\r\n",
            "resources": [
              "$resourceURI"
            ],
            "timeColumn": "TimeGenerated"
          },
          "queryType": "Azure Log Analytics",
          "refId": "A"
        },
        "refresh": 2,
        "regex": "",
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "ALL",
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "grafana-azure-monitor-datasource",
          "uid": "${am_ds}"
        },
        "definition": "",
        "includeAll": true,
        "label": "Destination Workload",
        "name": "dst_workload",
        "options": [],
        "query": {
          "azureLogAnalytics": {
            "dashboardTime": true,
            "query": "// Schema harmonization for both table types\r\nlet UnifiedFlowLogs =\r\n    union isfuzzy=true\r\n(\r\n    RetinaNetworkFlowLogs\r\n    | project DestinationPodName, DestinationNamespace\r\n),\r\n(\r\n    ContainerNetworkLogs\r\n    | project DestinationPodName, DestinationNamespace\r\n);\r\nUnifiedFlowLogs\r\n// hack so as to not query the table if src_ns == ALL\r\n| extend podname = iff(\"${src_ns:json}\" == 'ALL', 'ALL', DestinationPodName)\r\n| extend ns = iff(\"${src_ns:json}\" == 'ALL', 'ALL', DestinationNamespace)\r\n| summarize count() by podname, ns\r\n| where ns == \"${src_ns:json}\"\r\n| where podname != 'ALL' and isnotempty(podname)\r\n| extend workload_name = replace_regex(tostring(podname), @'^(.*?)(?:-[^-]*)?$', @'\\1')\r\n| distinct workload_name\r\n",
            "resources": [
              "$resourceURI"
            ],
            "timeColumn": "TimeGenerated"
          },
          "queryType": "Azure Log Analytics",
          "refId": "A"
        },
        "refresh": 2,
        "regex": "",
        "sort": 1,
        "type": "query"
      },
      {
        "current": {
          "text": [
            "2",
            "-1"
          ],
          "value": [
            "2",
            "-1"
          ]
        },
        "includeAll": false,
        "label": "Included when namespace=all",
        "multi": true,
        "name": "inclusions",
        "options": [
          {
            "selected": true,
            "text": "world",
            "value": "2"
          },
          {
            "selected": true,
            "text": "local nodes",
            "value": "-1"
          }
        ],
        "query": "world : 2, local nodes : -1",
        "type": "custom"
      }
    ]
  },
  "time": {
    "from": "now-5m",
    "to": "now"
  },
  "timepicker": {},
  "timezone": " ",
  "title": "Azure / Insights / Containers / Networking / Flow Logs",
  "uid": "InsightsContainersNetworkingFlowLogs",
  "version": 1
}